<!DOCTYPE HTML>
<html>

  <head>

    <title>Shalendar | <%= @user[:username] %></title>

    <!-- jquery -->
    <script src='/fc/lib/jquery.min.js'></script>

    <!-- utilities -->
    <script src='/fc/lib/moment.min.js'></script>

    <!-- vue -->
    <script src='/bower_components/vue/dist/vue.min.js'></script>

    <!-- fontawesome -->
    <link rel="stylesheet" href="/bower_components/font-awesome/css/font-awesome.min.css">

    <!-- sweetalert -->
    <link rel="stylesheet" href="/bower_components/sweetalert/dist/sweetalert.css">
    <script src="/bower_components/sweetalert/dist/sweetalert.min.js"></script>

    <!-- fc -->
    <link href='/fc/fullcalendar.css' rel='stylesheet' />
    <link href='/fc/fullcalendar.print.css' rel='stylesheet' media='print' />
    <script src='/fc/fullcalendar.min.js'></script>

    <!-- css -->
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.2.3/css/bulma.css">
    <link rel="stylesheet" href="/site/css/site.css">
    <!-- webpack -->
    <!-- <script src='//webpack.shalendar.docker/static/bundle.js'></script> -->


  </head>

  <body class="calendar full_height">

    <div id="app" class="full_height">
      <div class="columns full_height">

        <!-- left -->
        <div id="left_p" class="column is-narrow left-calendar">

          <!-- <input type="text" class="form-control" placeholder="Search"> -->
          <div class="left_p_head column" style="width: 250px;">
            My Calendars  ({{calendars.length}})
            <span class="left-add-calendar" @click="add_calendar" v-if="has_access()">+</span>
          </div>

          <div class="left_p_body column">
            <ul>
              <li :class="is_active_calendar('all')">
                <!-- <i class="fa fa-calendar-o" aria-hidden="true"></i> -->
                <a @click="set_active_calendar()">All</a>
              </li>
              <ul>
                <li v-for="calendar in calendars" :class="is_active_calendar(calendar)">
                  <!-- <i class="fa fa-circle" aria-hidden="true"></i> -->
                  <a href="#" @click.prevent="set_active_calendar(calendar)">{{calendar.name}}</a>
                </li>
              </ul>
            </ul>
          </div>

          <div class="left_p_footer column">
            <div v-if="current_user">
              <p>Welcome <%= @user[:username] %>{{current_user.first_name}}, <a href="/user/logout">Logout</a></p>
            </div>
            <div v-if="!current_user">
              <p>You are not logged in, <a href="/user/login">Login</a></p>
            </div>
          </div>

        </div>

        <!-- middle -->
        <div class="column">

          <div class="container-fluid">
            <div class="row">

              <div class="col-md-12 col-main-top top-calendar">

                <div class="row">
                  <div class="col-md-1 calendar-banner"><img src="/assets/images/profile_img.jpg" height="120"></div>
                  <div class="col-md-7 col-header-description">
                    <h2>Slack</h2>
                    <div class="calendar-description">
                      We provide a messaging platform that rocks and lets you host rooms
                      and privately share conversations with team members.
                    </div>
                    <div class="calendar-stats">
                      <div class=""><h4>34 following | 12 followers</h4></div>
                    </div>
                    <div class="calendar-follow">
                      <div class="calendar-follow-button"><button class="btn btn-warning">Follow</button> </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div id="calendar" class="col-md-12 col-main-content" style="width: 100%;"></div>
                  <div class="row">
                    <div id="calendar" class="col-md-12 col-main-content" style="width: 100%;"></div>
                    <event-modal id="modal_event" v-if="modal_event" :active_calendar="active_calendar" :cal="cal" :close_event="close_event" :active_event="active_event" @close="modal_event = false"></event-modal>
                  </div>
                </div>

              </div>

            </div> 

          </div>

        </div>

        <!-- end middle -->

      </div>
    </div>


    <script type="text/x-template" id="event-modal-template">
      <transition name="modal">
        <div class="modal-mask" @click="$emit('close')">
          <div class="modal-wrapper" style="height: 100%;">
            <div class="modal-container">
              <div class="modal-body" @click.stop>
                <slot name="body">

                  <form @submit="save_event">

                    <h3>What Happened On This Day?</h3>
                    <label class="label">What</label>
                    <p class="control">
                      <input id="active_event_title" v-model="active_event.title" class="input is-info" type="text" placeholder="A short sentence describing the event">
                    </p>
                    <label class="label">Description (optional)</label>
                      <p class="control has-icon has-icon-right">
                      <textarea v-model="active_event.description" class="textarea" placeholder="Describe what happened"></textarea>
                    </p>
                    <label class="label">Where (optional)</label>
                    <p class="control has-icon has-icon-right">
                      <input v-model="active_event.location" class="input" type="text" placeholder="city or location">
                    </p>

                    <div class="modal_action">
                      <button class="button is-info is-outlined modal-default-button">
                        Save Event
                      </button>
                    </div>
                  </form>

                </slot>
              </div>
            </div>
          </div>
        </div>
      </transition>
    </script>


    <script>

      Vue.component('event-modal', {
        template: '#event-modal-template',
        props: ['active_event', 'active_calendar', 'close_event', 'date', 'cal'],
        methods: {
         save_event: function(date, event){
           var _this = this
           if (_this.active_event.title) {

             // setup payload
             var event = {
               title: _this.active_event.title,
               start: _this.active_event.date.utc().format(),
               end: _this.active_event.date.utc().add(1, 'day').format(),
               description: _this.active_event.description || null,
               location: _this.active_event.location || null
             }

             // if calendar selected, add calendar_id to payload
             if(_this.active_calendar) event.calendar_id = _this.active_calendar.id

             // post to /api/event
             $.post('/api/event', event, function (res) {
               _this.close_event()
               _this.cal.fullCalendar('renderEvent', res);
               swal("Nice!", "Event has been posted on your calendar", "success");
             })

           }
         }
        }
      })

     new Vue({
       el: '#app',
       data: {
         user: <%== @user.to_json %>,
         current_user: <%== session[:user].to_json %>,
         calendars: [],
         active_calendar: null,
         eventsources: [],
         cal: {},
         events: [],
         modal_event: false,
         active_event: {}
       },

       mounted: function(){
         this.get_calendars();
         this.init_calendar();
         this.set_active_calendar();
         //this.get_events();
       },

       methods: {

         save_eventsource: function(source){
           this.eventsources.push(source);
           this.cal.fullCalendar('addEventSource', source)
         },

         remove_eventsource: function(source){
           var idx = $.inArray(source, this.eventsources)
             console.log(idx)
             this.cal.fullCalendar('removeEventSource', source);
         },

         has_access: function(){
           if(!this.current_user) return false
           if(this.user.id == this.current_user.id){
             return true
           }
         },

         is_active_calendar: function(calendar){
           if(this.active_calendar && (this.active_calendar.id == calendar.id) ){
             return 'active'
           }
           if(calendar == 'all' && !this.active_calendar) return 'active'
         },

         unset_calendar: function(calendar){
           this.active_calendar = null;
           this.eventsources = []
           this.cal.fullCalendar('removeEventSources')
             this.cal.fullCalendar('removeEvents')
         },

         set_active_calendar: function(calendar){

           this.unset_calendar(calendar);

           if(calendar){
             console.log('active calendar', calendar)
               this.active_calendar = calendar;
             this.save_eventsource("/api/events?user_id="+this.user.id+"&calendar_id="+calendar.id);
             //this.cal.fullCalendar.refetchEvents();
             location.hash = calendar.name
           }else{
             this.save_eventsource("/api/events?user_id="+this.user.id);
             location.hash = ''
           }
           console.log(this.eventsources)
         },

         get_calendars: function(){
           var _this = this
           $.get("/api/calendars", {user_id: this.user.id}, function(res){
             _this.calendars = res
             console.log(res)
           })
         },

         add_calendar: function(){
           var _this = this
           swal({
             title: "Add a calendar",
             text: "What do you want to call it?",
             type: "input",
             showCancelButton: true,
             closeOnConfirm: false,
             animation: "slide-from-top",
             inputPlaceholder: "Write something"
           }, function(calendar_name){
             if (calendar_name === false) return false
             if (calendar_name === "") {
               swal.showInputError("You need to write something!")
                 return false
             }

             var color = '#e6ecf1'

             $.post("/api/calendar", {user_id: _this.user.id, name: calendar_name, color: color }, function(res){
               swal("Nice!", "You just created a calendar: " + calendar_name, "success")
                 _this.get_calendars()
             })

           })
         },

         init_calendar: function(){
           var _this = this
           console.log('init calendar')
             var cal = $('#calendar')
             _this.cal = cal

           cal.fullCalendar({
             defaultDate: moment(),
             editable: true,
             eventLimit: true, // allow "more" link when too many events
             aspectRatio: 2.5,
             firstDay: 1,
             fixedWeekCount: false,
             header: {
               left: 'prev,next today',
               center: 'title',
               right: 'listDay,listWeek,month'
             },
             views: {
               listDay: { buttonText: 'day' },
               listWeek: { buttonText: 'week' }
             },
             displayEventTime: false,
             dayClick: function (date, jsEvent, view) {
               _this.show_add_event(date)
             },
             eventClick: function(calEvent, jsEvent, view) {
               alert('Event: ' + calEvent.title);
               alert('Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY);
               alert('View: ' + view.name);

               // change the border color just for fun
               $(this).css('border-color', 'red');
             },

             //events: "/api/events?user_id="+_this.user.id,
             //eventSources: _this.eventsources,

           });

         },

         show_add_event: function(date){
           this.active_event = {}
           if (this.user.id == this.current_user.id){
             this.active_event.date = date
             this.modal_event = true

             setTimeout(function(){
               $("#active_event_title").focus();
             }, 500)

           }
         },

         close_event: function(){
           this.modal_event = false
         }

       }
     })

    </script>


  </body>

  
</html>
